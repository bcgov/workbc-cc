<?php

use Drupal\Core\Url;
use Drupal\image\Entity\ImageStyle;

function workbc_cdq_career_match_page_attachments_alter(array &$attachments) {
	$attachments['#attached']['library'][] = 'workbc_cdq_career_match/workbc-cdq-career-match';
}

/**
* Implements hook_theme().
*/
function workbc_cdq_career_match_theme($existing, $type, $theme, $path) {
  return [
    'views_view_table__quiz_career_match' => [
      'template' => 'views/views-view-table--quiz_career_match',
      'base hook' => 'view'
    ],
    'views_view_field__quiz_career_match__selected' => [
      'template' => 'views/views-view-field--quiz_career_match--selected',
      'base hook' => 'view'
    ],    
    'views_view_fields__cdq_compare_careers__page' => [
      'template' => 'views/views-view-fields--cdq_compare_careers--page',
      'base hook' => 'view'
    ],     
  ];
}


function workbc_cdq_career_match_preprocess_views_view_table(&$variables) {

  $view = $variables['view'];

  if ($view->id() == "quiz_career_match") {
    $results = $variables['result'];

    $preview = [];
    foreach ($variables['result'] as $key => $result) {
      $node = $result->_relationship_entities['nid'];
      $variables['rows'][$key]['raw'] = workbc_cdq_career_profile_info($node);
      $variables['submission_id'] = $variables['view']->args[0];
      $variables['workbc_url'] = rtrim("https://devnoc.workbc.ca", "/");
    }
  }
}


function workbc_cdq_career_match_preprocess_views_view_field(&$variables) {

  if ($variables['view']->id() === "quiz_career_match" && $variables['field']->realField === "selected") {
    $variables['career_match_id'] = $variables['row']->id;
  }
  if ($variables['view']->id() === "quiz_career_match" && $variables['field']->realField === "career_match") {
    $value = $variables['field']->getValue($variables['row']);
    $output = $variables['field']->advancedRender($variables['row']);
    $output = str_replace($value, round($value, 0), $output);
    $variables['output'] = $output;
  }
}

function workbc_cdq_career_match_preprocess_views_view_fields(&$variables) {

  $node = $variables['row']->_relationship_entities['nid'];
  $info = workbc_cdq_career_profile_info($node);
  $variables['raw'] = $info;
  $variables['workbc_url'] = rtrim("https://devnoc.workbc.ca", "/");
}



function workbc_cdq_career_profile_info(\Drupal\node\NodeInterface $node) {

  $image_url = "";
  if ($node->field_image->entity) {
    $style = ImageStyle::load('career_profile_preview');
    $image_url = $style->buildUrl($node->field_image->entity->getFileUri());
  }


  $term = $node->field_education_level->referencedEntities();
  $info = array(
    'title' => $node->title->value . " (NOC " . $node->field_noc->value . ")",
    'noc' => $node->field_noc->value,
    'job_summary' => substr(strip_tags($node->body->value), 0, 400),
    'video_id' => $node->field_video_id->value,
    'image' => $image_url,
    'annual_salary' => $node->field_annual_salary->value,
    'education_level' => $term[0]->getName(),
    'job_openings' => $node->field_job_openings->value,
    'job_openings_range' => '(1995 - 2005)',
  );

  return $info;
}


/**
 * Implements hook_webform_third_party_settings_form_alter().
 */
function workbc_cdq_career_match_webform_third_party_settings_form_alter(array &$form, FormStateInterface $form_state) {
  /** @var \Drupal\webform\WebformInterface $webform */
  $webform = $form_state->getFormObject()->getEntity();

  $form['third_party_settings']['workbc_cdq'] = [
    '#type' => 'details',
    '#title' => t('WorkBC CDQ settings'),
    '#open' => TRUE,
  ];
  $vocabularies = \Drupal::entityTypeManager()->getStorage('taxonomy_vocabulary')->loadMultiple();
  $form['third_party_settings']['workbc_cdq']['categories'] = [
    '#type' => 'select',
    '#title' => t('Quiz categories'),
    '#description' => t('The categories that apply to the questions of this quiz.'),
    '#default_value' => $webform->getThirdPartySetting('workbc_cdq', 'categories'),
    '#options' => array_merge([0 => '- none - '], array_reduce(array_keys($vocabularies), function($options, $key) use($vocabularies) {
      if (str_contains($key, 'categories')) {
        $options[$key] = $vocabularies[$key]->get('name');
      }
      return $options;
    }, []))
  ];
}

/**
 * Implements hook_webform_element_default_properties_alter().
 */
function workbc_cdq_career_match_webform_element_default_properties_alter(array &$properties, array &$definition) {
  // Add custom data property to all webform elements.
  // Setting the custom property to an empty string makes the corresponding
  // element defined via hook_webform_element_configuration_form_alter()
  // automatically visible.
  $properties['category'] = '';
}

/**
 * Implements hook_webform_element_translatable_properties_alter().
 */
function workbc_cdq_career_match_webform_element_translatable_properties_alter(array &$properties, array &$definition) {
  // Make the custom data property translatable.
  $properties[] = 'category';
}

/**
 * Implements hook_webform_element_configuration_form_alter().
 */
function workbc_cdq_career_match_webform_element_configuration_form_alter(&$form, FormStateInterface $form_state) {
  // If you want add element properties to specific element type, you can use
  // the below code to the current element's type and more.
  /** @var Drupal\webform_ui\Form\WebformUiElementEditForm $form_object */
  $form_object = $form_state->getFormObject();
  $element_plugin = $form_object->getWebformElementPlugin();
  $element_label = $element_plugin->getPluginLabel();
  $element_type = $element_plugin->getTypeName();
  $webform = $element_plugin->getWebform();
  $settings = $webform->get('third_party_settings');

  // Append custom properties details container and textfield element.
  $t_args = [
    '@label' => $element_label,
    '@type' => $element_type,
  ];
  $form['workbc_cdq'] = [
    '#type' => 'details',
    '#title' => t('WorkBC CDQ properties'),
    '#description' => t('Properties related to WorkBC CDQ.'),
    '#open' => TRUE,
    // Add custom properties after all fieldset elements, which have a
    // weight of -20.
    // @see \Drupal\webform\Plugin\WebformElementBase::buildConfigurationForm
    '#weight' => -10,
  ];
  $terms = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadTree($settings['workbc_cdq']['categories']);
  $form['workbc_cdq']['category'] = [
    '#type' => 'select',
    '#title' => t('Question category'),
    '#description' => t('The category to which this question belongs.', $t_args),
    '#options' => array_reduce($terms, function($options, $term) {
      $options[$term->tid] = $term->name;
      return $options;
    })
  ];
}
